<!DOCTYPE html>

<html>
<head>
  <title>keenio-middleware.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="index.html">
                index.js
              </a>
            
              
              <a class="source" href="default-options.html">
                default-options.js
              </a>
            
              
              <a class="source" href="event-collection.html">
                event-collection.js
              </a>
            
              
              <a class="source" href="keen-event.html">
                keen-event.js
              </a>
            
              
              <a class="source" href="keenio-middleware.html">
                keenio-middleware.js
              </a>
            
              
              <a class="source" href="routes.html">
                routes.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>keenio-middleware.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-pi">"use strict"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Grab dependencies required by the middleware.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> util         = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>),
    keen         = <span class="hljs-built_in">require</span>(<span class="hljs-string">'keen.io'</span>),
    friendwares  = <span class="hljs-built_in">require</span>(<span class="hljs-string">'connect-friendwares'</span>),
    EventEmitter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>).EventEmitter;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Grab internal modules used bt the middleware.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> helpers       = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./core/helpers'</span>),
    optionsParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./core/options-parser'</span>);

<span class="hljs-keyword">var</span> RoutesModule          = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./routes'</span>),
    ProxyResponseModule   = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./parse/proxy-response'</span>),
    RequestModule         = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./parse/request'</span>),
    IdentifyModule        = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./parse/identify'</span>),
    EventCollectionModule = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./event-collection'</span>),
    KeenEventModule       = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./keen-event'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Construct the middleware uninitialised with some default events.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">KeenioMiddleware</span> <span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">this</span>.options = {};
  <span class="hljs-keyword">this</span>.handlers = {};
  <span class="hljs-keyword">this</span>.initialized = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>This initialises an internal <code>_ee</code> EventEmitter with the events: error, info, track and flush.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>._ee = helpers.setDefaultEvents(<span class="hljs-keyword">new</span> EventEmitter(), [<span class="hljs-string">'error'</span>, <span class="hljs-string">'info'</span>, <span class="hljs-string">'track'</span>, <span class="hljs-string">'flush'</span>]);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Bind the EventEmitter methods to the middleware.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>helpers.forEach(EventEmitter.prototype, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn, key)</span> {</span>
  KeenioMiddleware.prototype[key] = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">this</span>._ee[key].apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
  };
});</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Before the middleware can be used it must have its configuration passed into it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>KeenioMiddleware.prototype.configure = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> {</span>
  <span class="hljs-keyword">this</span>.options = optionsParser.parse(options);
  
  <span class="hljs-keyword">this</span>._configureHandlers(<span class="hljs-keyword">this</span>.options);

  <span class="hljs-keyword">this</span>.keenClient = keen.configure(options.client);
  <span class="hljs-keyword">this</span>.initialized = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'initialized'</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>A method may be called to check whether the middleware has had configure() called before
it is used. It will throw an exception if the middleware has not yet been initialised.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>KeenioMiddleware.prototype.checkInitialized = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.initialized) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'express-keenio middleware must be configured before use. Please call '</span> +
                    <span class="hljs-string">'keenio-middleware#configure(options).'</span>);
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>This method allows us to check that the middleware is in use by Express and not
just Connect. It does this by checking for the existence of a middleware called
&#39;expressInit&#39;. </p>
<p>The purpose of this is that the middleware requires some behaviours given by Express,
particularly relating to route definitions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>KeenioMiddleware.prototype.isMiddlewareUsedByExpress = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(app)</span> {</span>
  <span class="hljs-keyword">return</span> friendwares(app).has(<span class="hljs-string">'expressInit'</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>This is exposed in order that an instance of the middleware can be passed directly into 
app.use() - which either executions a function, or looks for the function at an object&#39;s
<code>handle</code> property.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>KeenioMiddleware.prototype.handle = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">keenioHandler</span><span class="hljs-params">(req, res, next)</span> {</span>
  <span class="hljs-keyword">var</span> middleware = <span class="hljs-keyword">this</span>.handleAll();
  middleware(req, res, next);
};

KeenioMiddleware.prototype.handleAll = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">this</span>.checkInitialized();

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._generateHandler({});
};</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p><code>trackRoute()</code> allows the possibility to attach the middlewares to specific Express.js
routes and to explicitly define their event collection name. </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>KeenioMiddleware.prototype.trackRoute = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(eventCollectionName, eventTag)</span> {</span>
  <span class="hljs-keyword">this</span>.checkInitialized();

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._generateHandler({
    eventCollectionName: eventCollectionName,
    tag: eventTag
  });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>This is an internal method, which generates the middleware handler when given a routeConfig.
The routeConfig must be empty if we are using the middleware against the whole app.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>KeenioMiddleware.prototype._generateHandler = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(routeConfig)</span> {</span>
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;

  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">keenioHandler</span><span class="hljs-params">(req, res, next)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>We ensure that the middleware is being used by an express app.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!req.app || !self.isMiddlewareUsedByExpress(req.app)) {
      self.emit(<span class="hljs-string">'error'</span>, <span class="hljs-string">'Currently this middleware is only supported by Express.js.'</span>);
      <span class="hljs-keyword">return</span> next();
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>We swap the methods on a response object with proxied versions, and respond
with a parsedResponseData object that is still in scope of the res object&#39;s proxied
response methods (closures.)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> parsedResponseData = self.proxyResponseHandler.proxyResponseObject(res);</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>We setup a function that will be called when a response is finished, and pass 
in the request object, routeConfig, and parsedResponseData object.
The parsedResponseData object at this point contains no data, but since it is
still in the scope of the proxied response object it will contain response data
by the time the response has had its <code>finish</code> event emitted.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    res.on(<span class="hljs-string">"finish"</span>, self._finishResponse(req, parsedResponseData, routeConfig));

    <span class="hljs-keyword">return</span> next();
  };
};

KeenioMiddleware.prototype._finishResponse = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(req, _parsedResponseData, routeConfig)</span> {</span>
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onResponseFinish</span><span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>It&#39;s only at the response &#39;finish&#39; event that we can be sure that req.route is set.
This is due to express populating it in the app.router middleware.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!req.route) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// If a non-route middleware has been run this would be the case. E.g. favicon.ico</span>
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>If a route is excluded in the configuration we end the middleware having made no requests
to Keen.IO.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (self.options.hasOwnProperty(<span class="hljs-string">'excludeRoutes'</span>)) {
      <span class="hljs-keyword">if</span> (self.routesHandler.isExcludedRoute(req.route)) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>If a route has data stored in the &#39;routes&#39; key of the configuration, we fetch this data.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (self.options.hasOwnProperty(<span class="hljs-string">'routes'</span>)) {
      <span class="hljs-keyword">var</span> eventCollectionMetadata = self.routesHandler.getRouteConfig(req.route);</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>If a route has no config but the configuration does have a routes key then consider it excluded.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (!eventCollectionMetadata) { <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; }

      routeConfig = helpers.extend({}, eventCollectionMetadata, routeConfig);
    }

    <span class="hljs-keyword">var</span> identity = self.identifyHandler.identify(req),
        parsedRequestData = self.requestHandler.parseRequestObject(req),
        parsedResponseData = _parsedResponseData;
    
    <span class="hljs-keyword">var</span> eventCollection, keenEvent;</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>We test to see if an event collection name is defined by any configuration and that it is valid.
If it is not valid then we generate it from the route.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (routeConfig.eventCollectionName) {
      <span class="hljs-keyword">if</span> (self.eventCollectionHandler._isValidEventCollectionName(routeConfig.eventCollectionName)) {
        eventCollection = routeConfig.eventCollectionName;
      } <span class="hljs-keyword">else</span> {
        self.emit(<span class="hljs-string">'error'</span>, <span class="hljs-string">'ERROR: '</span> + routeConfig.eventCollectionName + <span class="hljs-string">' is not a valid event collection name so another has been automatically generated.'</span>);
        eventCollection = self.eventCollectionHandler.generateName(req.route);
      }
    } <span class="hljs-keyword">else</span> {
      eventCollection = self.eventCollectionHandler.generateName(req.route);
    }

    keenEvent = self.keenEventHandler.generateEvent(identity, parsedRequestData, parsedResponseData, routeConfig);

    self._track(eventCollection, keenEvent);
  };
};

KeenioMiddleware.prototype._track = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(eventCollection, keenEvent)</span> {</span>
  <span class="hljs-keyword">var</span> keenioMiddlewareScope = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">"track"</span>, { eventCollection: eventCollection, keenEvent: keenEvent });
  <span class="hljs-keyword">this</span>.keenClient.addEvent(eventCollection, keenEvent, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, res)</span> {</span>
    <span class="hljs-keyword">if</span> (err) {
      <span class="hljs-keyword">return</span> keenioMiddlewareScope.emit(<span class="hljs-string">"error"</span>, err);
    }

    <span class="hljs-keyword">if</span> (res.created) {
      keenioMiddlewareScope.emit(<span class="hljs-string">"info"</span>, <span class="hljs-string">"Keen.IO event created."</span>);
    } <span class="hljs-keyword">else</span> {
      keenioMiddlewareScope.emit(<span class="hljs-string">"info"</span>, <span class="hljs-string">"Keen.IO event not created."</span>);
    }
  });
};

KeenioMiddleware.prototype._configureHandlers = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> {</span>
  <span class="hljs-keyword">this</span>.routesHandler = <span class="hljs-keyword">new</span> RoutesModule(options, <span class="hljs-keyword">this</span>._ee);
  <span class="hljs-keyword">this</span>.proxyResponseHandler = <span class="hljs-keyword">new</span> ProxyResponseModule(options, <span class="hljs-keyword">this</span>._ee);
  <span class="hljs-keyword">this</span>.requestHandler = <span class="hljs-keyword">new</span> RequestModule(options, <span class="hljs-keyword">this</span>._ee);
  <span class="hljs-keyword">this</span>.identifyHandler = <span class="hljs-keyword">new</span> IdentifyModule(options, <span class="hljs-keyword">this</span>._ee);
  <span class="hljs-keyword">this</span>.eventCollectionHandler = <span class="hljs-keyword">new</span> EventCollectionModule(options, <span class="hljs-keyword">this</span>._ee);
  <span class="hljs-keyword">this</span>.keenEventHandler = <span class="hljs-keyword">new</span> KeenEventModule(options, <span class="hljs-keyword">this</span>._ee);
};

exports = module.exports = <span class="hljs-keyword">new</span> KeenioMiddleware();</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
